import{j as l}from"./jsx-runtime-u17CrQMm.js";import{r as d}from"./index-Bi6L2ga8.js";function q(o){const t=[],r=[];for(let e=o.length-1;e>=0;e--){const n=o[e];n&&r.push([n,0])}for(;r.length>0;){const e=r.pop();if(!e)break;const[n,c]=e;if(t.push({node:n,depth:c}),n.isOpen&&n.children.length>0)for(let i=n.children.length-1;i>=0;i--){const s=n.children[i];s&&r.push([s,c+1])}}return t}function R(o,t){const r=[...o];for(;r.length>0;){const e=r.pop();if(e){if(e.id===t)return e;for(let n=e.children.length-1;n>=0;n--){const c=e.children[n];c&&r.push(c)}}}return null}function j(o,t,r=!1){return{id:o,label:t,children:[],isOpen:!1,isSelected:!1,isIndeterminate:!1,isLoading:!1,hasChildren:r}}const z=500;function B(o,t){const r=4+Math.floor(Math.random()*5),e=[];for(let n=0;n<r;n++){const c=`${o}-${n}`,i=`${t} › Item ${n+1}`,s=Math.random()>.5;e.push(j(c,i,s))}return e}function X(o,t){return new Promise(r=>{setTimeout(()=>{const e=B(o,t);r(e)},z)})}function Y(){return["Engineering","Design","Product","Marketing","Sales","Operations","Finance","Human Resources"].map((t,r)=>j(`root-${r}`,t,!0))}function K(o){const t=o?.fetchChildrenFn??X,[r,e]=d.useState(()=>o?.initialRootNodes??Y()),[n,c]=d.useState(null),i=d.useMemo(()=>q(r),[r]),s=d.useCallback((u,h)=>{e(m=>{function a(b){return b.map(C=>{const N={...C,children:a(C.children)};return N.id===u?h(N):N})}return a(m)})},[]),w=d.useCallback(u=>{const h=R(r,u);if(h){if(h.children.length>0){s(u,m=>({...m,isOpen:!m.isOpen}));return}h.hasChildren&&!h.isLoading&&(c(null),s(u,m=>({...m,isLoading:!0})),t(u,h.label).then(m=>{s(u,a=>({...a,children:m,isLoading:!1,isOpen:!0}))},m=>{s(u,b=>({...b,isLoading:!1}));const a=m instanceof Error?m.message:"Failed to load children";c(a)}))}},[r,s,t]),x=d.useCallback(u=>{e(h=>{const m=A(h),a=R(m,u);if(!a)return h;const b=!a.isSelected;return M(a,b),H(m),m})},[]),y=d.useMemo(()=>{const u=[];function h(m){for(const a of m)a.isSelected&&u.push({id:a.id,label:a.label}),!a.isSelected&&a.children.length>0&&h(a.children)}return h(r),u},[r]),v=d.useCallback(u=>{x(u)},[x]),k=d.useCallback(()=>{c(null)},[]);return{flatNodes:i,rootNodes:r,selectedNodes:y,error:n,toggleExpand:w,toggleSelect:x,deselectNode:v,clearError:k}}function A(o){return o.map(t=>({...t,children:A(t.children)}))}function M(o,t){o.isSelected=t,o.isIndeterminate=!1;for(const r of o.children)M(r,t)}function H(o){let t=0,r=0;for(const e of o){if(e.children.length>0){const[n,c]=H(e.children),i=n===c&&c>0,s=n===0,w=e.children.some(x=>x.isIndeterminate);i?(e.isSelected=!0,e.isIndeterminate=!1):s&&!w?(e.isSelected=!1,e.isIndeterminate=!1):(e.isSelected=!1,e.isIndeterminate=!0)}r++,e.isSelected&&t++}return[t,r]}function V({containerRef:o,itemCount:t,itemHeight:r,overscan:e=5}){const[n,c]=d.useState(0),[i,s]=d.useState(0),w=d.useRef(0),x=d.useCallback(()=>{const a=o.current;if(!a)return;const b=a.scrollTop;w.current=b,requestAnimationFrame(()=>{c(b)})},[o]);d.useEffect(()=>{const a=o.current;if(!a)return;s(a.clientHeight),a.addEventListener("scroll",x,{passive:!0});const b=new ResizeObserver(C=>{for(const N of C)s(N.contentRect.height)});return b.observe(a),()=>{a.removeEventListener("scroll",x),b.disconnect()}},[o,x]);const y=t*r,v=Math.floor(n/r),k=Math.ceil(i/r),u=Math.max(0,v-e),h=Math.min(t-1,v+k+e),m=[];if(t>0)for(let a=u;a<=h;a++)m.push({index:a,offsetTop:a*r});return{virtualItems:m,totalHeight:y}}const J=20;function $({flatNode:o,offsetTop:t,rowHeight:r,isHighlighted:e,optionId:n,onToggleExpand:c,onToggleSelect:i}){const{node:s,depth:w}=o,x=d.useCallback(h=>{h.stopPropagation(),c(s.id)},[s.id,c]),y=d.useCallback(h=>{h.stopPropagation()},[]),v=d.useCallback(()=>{i(s.id)},[s.id,i]),k=d.useCallback(()=>{i(s.id)},[s.id,i]),u=12+w*J;return l.jsxs("div",{id:n,role:"option","aria-selected":s.isSelected,"aria-expanded":s.hasChildren?s.isOpen:void 0,onClick:k,className:["absolute left-0 right-0 flex cursor-pointer items-center text-sm","transition-colors duration-75",e?"bg-primary-50":"hover:bg-neutral-50"].join(" "),style:{height:`${r}px`,top:`${t}px`,paddingLeft:`${u}px`},children:[s.hasChildren?l.jsx("button",{type:"button",tabIndex:-1,onClick:x,className:["mr-xs flex h-5 w-5 flex-shrink-0 items-center justify-center","rounded-sm text-neutral-500 hover:bg-neutral-100 hover:text-neutral-700","transition-colors duration-100"].join(" "),"aria-label":s.isOpen?`Collapse ${s.label}`:`Expand ${s.label}`,"aria-hidden":"true",children:s.isLoading?l.jsx("span",{className:"block h-3 w-3 animate-pulse rounded-sm bg-neutral-300"}):l.jsx("svg",{className:["h-3.5 w-3.5 transition-transform duration-150",s.isOpen?"rotate-90":""].join(" "),fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2.5,"aria-hidden":"true",children:l.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 5l7 7-7 7"})})}):l.jsx("span",{className:"mr-xs inline-block h-5 w-5 flex-shrink-0","aria-hidden":"true"}),l.jsx("input",{type:"checkbox",tabIndex:-1,checked:s.isSelected,ref:h=>{h&&(h.indeterminate=s.isIndeterminate)},onClick:y,onChange:v,className:["mr-sm h-4 w-4 flex-shrink-0 cursor-pointer rounded-sm","border-neutral-300 text-primary-600","focus:ring-2 focus:ring-primary-500 focus:ring-offset-1"].join(" "),"aria-label":`Select ${s.label}`}),l.jsx("span",{className:["truncate",s.isSelected?"font-medium text-neutral-900":"text-neutral-700"].join(" "),children:s.label})]})}$.__docgenInfo={description:`TreeRow — a single absolutely-positioned row inside the virtualized list.\r
\r
Indentation:\r
  paddingLeft = depth × INDENT_PX\r
  This creates the visual nesting without nested DOM elements.\r
  A root node (depth 0) has no extra padding. A grandchild (depth 2)\r
  gets 40px of indent.\r
\r
Loading skeleton:\r
  When a node's children are being fetched (isLoading = true),\r
  the expand icon is replaced with a pulsing bar. This gives\r
  the user immediate feedback that something is happening.\r
\r
ARIA:\r
  Each row carries role="option" and aria-selected reflecting the\r
  checkbox selection state. Branch nodes also carry aria-expanded.\r
  The row's DOM id is used by the trigger's aria-activedescendant\r
  to communicate the current keyboard-highlighted item to assistive\r
  technology.`,methods:[],displayName:"TreeRow",props:{flatNode:{required:!0,tsType:{name:"FlatNode"},description:""},offsetTop:{required:!0,tsType:{name:"number"},description:"Absolute pixel offset from the top of the scroll content"},rowHeight:{required:!0,tsType:{name:"number"},description:"Row height in pixels — must match the virtualizer's itemHeight"},isHighlighted:{required:!0,tsType:{name:"boolean"},description:"Whether this row is the keyboard-highlighted (active descendant) row"},optionId:{required:!0,tsType:{name:"string"},description:"Unique DOM id for this option — used by aria-activedescendant"},onToggleExpand:{required:!0,tsType:{name:"signature",type:"function",raw:"(nodeId: string) => void",signature:{arguments:[{type:{name:"string"},name:"nodeId"}],return:{name:"void"}}},description:""},onToggleSelect:{required:!0,tsType:{name:"signature",type:"function",raw:"(nodeId: string) => void",signature:{arguments:[{type:{name:"string"},name:"nodeId"}],return:{name:"void"}}},description:""}}};const _=5;function P({selectedNodes:o,onRemove:t}){if(o.length===0)return null;const r=o.slice(0,_),e=o.length-_;return l.jsxs("div",{className:"flex flex-wrap gap-xs",children:[r.map(n=>l.jsx(Q,{nodeId:n.id,label:n.label,onRemove:t},n.id)),e>0&&l.jsxs("span",{className:"inline-flex items-center rounded-md bg-neutral-100 px-sm py-xs text-xs font-medium text-neutral-600",children:["+",e," more"]})]})}function Q({nodeId:o,label:t,onRemove:r}){const e=d.useCallback(n=>{n.stopPropagation(),r(o)},[o,r]);return l.jsxs("span",{className:"inline-flex items-center gap-xs rounded-md bg-primary-100 px-sm py-xs text-xs font-medium text-primary-800",children:[l.jsx("span",{className:"max-w-24 truncate",children:t}),l.jsx("button",{type:"button",onClick:e,className:"flex h-3.5 w-3.5 items-center justify-center rounded-full text-primary-600 hover:bg-primary-200 hover:text-primary-900","aria-label":`Remove ${t}`,children:l.jsx("svg",{className:"h-3 w-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2.5,children:l.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M6 18L18 6M6 6l12 12"})})})]})}P.__docgenInfo={description:`SelectedTags — pill-style tags displayed inside the combobox input area.\r
\r
Each tag shows the node's label and an × button to deselect it.\r
When more than MAX_VISIBLE_TAGS are selected, the overflow is\r
collapsed into a "+N more" badge.`,methods:[],displayName:"SelectedTags",props:{selectedNodes:{required:!0,tsType:{name:"Array",elements:[{name:"SelectedNode"}],raw:"SelectedNode[]"},description:""},onRemove:{required:!0,tsType:{name:"signature",type:"function",raw:"(nodeId: string) => void",signature:{arguments:[{type:{name:"string"},name:"nodeId"}],return:{name:"void"}}},description:""}}};const L=32,O="hcb-option-";function F(o={}){const[t,r]=d.useState(!1),[e,n]=d.useState(-1),c={};o.initialRootNodes&&(c.initialRootNodes=o.initialRootNodes),o.fetchChildrenFn&&(c.fetchChildrenFn=o.fetchChildrenFn);const{flatNodes:i,selectedNodes:s,error:w,toggleExpand:x,toggleSelect:y,deselectNode:v,clearError:k}=K(c),u=d.useRef(null),h=d.useRef(null),m=d.useRef(null),{virtualItems:a,totalHeight:b}=V({containerRef:u,itemCount:i.length,itemHeight:L,overscan:5}),C="hcb-listbox",N=e>=0&&e<i.length?`${O}${i[e]?.node.id??""}`:void 0;d.useEffect(()=>{function p(g){const f=h.current;f&&(f.contains(g.target)||(r(!1),n(-1)))}return document.addEventListener("mousedown",p),()=>{document.removeEventListener("mousedown",p)}},[]),d.useEffect(()=>{if(e<0||!u.current)return;const p=u.current,g=e*L,f=g+L,D=p.scrollTop,U=D+p.clientHeight;g<D?p.scrollTop=g:f>U&&(p.scrollTop=f-p.clientHeight)},[e]);const W=d.useCallback(()=>{r(p=>{const g=!p;return g||n(-1),g})},[]),G=d.useCallback(p=>{const g=i.length;switch(p.key){case"ArrowDown":{p.preventDefault(),t?n(f=>Math.min(f+1,g-1)):(r(!0),n(0));break}case"ArrowUp":{p.preventDefault(),t&&n(f=>Math.max(f-1,0));break}case"ArrowRight":{if(p.preventDefault(),t&&e>=0){const f=i[e];f&&f.node.hasChildren&&!f.node.isOpen&&x(f.node.id)}break}case"ArrowLeft":{if(p.preventDefault(),t&&e>=0){const f=i[e];f&&f.node.isOpen&&x(f.node.id)}break}case"Enter":{if(p.preventDefault(),!t)r(!0),n(0);else if(e>=0){const f=i[e];f&&y(f.node.id)}break}case"Home":{p.preventDefault(),t&&g>0&&n(0);break}case"End":{p.preventDefault(),t&&g>0&&n(g-1);break}case"Escape":{p.preventDefault(),r(!1),n(-1),m.current?.focus();break}}},[t,e,i,x,y]);return l.jsxs("div",{ref:h,className:"relative w-full max-w-md",children:[l.jsxs("button",{ref:m,type:"button",role:"combobox","aria-expanded":t,"aria-haspopup":"listbox","aria-controls":t?C:void 0,"aria-activedescendant":t?N:void 0,"aria-label":"Select items from hierarchical list",onClick:W,onKeyDown:G,className:["flex w-full min-h-10 items-center gap-sm","rounded-md border bg-white px-md py-sm text-sm","transition-colors duration-150","focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-1",t?"border-primary-500 ring-1 ring-primary-500":"border-neutral-300 hover:border-neutral-400"].join(" "),children:[l.jsx("div",{className:"flex flex-1 flex-wrap items-center gap-xs overflow-hidden",children:s.length>0?l.jsx(P,{selectedNodes:s,onRemove:v}):l.jsx("span",{className:"truncate text-neutral-400",children:"Select items…"})}),l.jsx("svg",{className:["ml-sm h-4 w-4 flex-shrink-0 text-neutral-400 transition-transform duration-200",t?"rotate-180":""].join(" "),fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,"aria-hidden":"true",children:l.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19 9l-7 7-7-7"})})]}),t&&l.jsxs("div",{className:["absolute left-0 top-full z-10 mt-xs w-full","rounded-md border border-neutral-200 bg-white shadow-lg"].join(" "),children:[l.jsx("div",{ref:u,id:C,role:"listbox","aria-label":"Hierarchical options","aria-multiselectable":"true",className:"relative overflow-y-auto",style:{maxHeight:"var(--combobox-max-height)"},children:l.jsx("div",{className:"relative w-full",style:{height:`${b}px`},children:a.map(p=>{const g=i[p.index];return g?l.jsx($,{flatNode:g,offsetTop:p.offsetTop,rowHeight:L,isHighlighted:p.index===e,optionId:`${O}${g.node.id}`,onToggleExpand:x,onToggleSelect:y},g.node.id):null})})}),i.length===0&&!w&&l.jsx("div",{className:"px-md py-lg text-center text-sm text-neutral-400",role:"status",children:"No items available"}),w&&l.jsxs("div",{role:"alert",className:"flex items-center justify-between border-t border-danger-500/20 bg-danger-500/10 px-md py-sm text-sm text-danger-600",children:[l.jsx("span",{children:w}),l.jsx("button",{type:"button",tabIndex:-1,onClick:k,className:"ml-sm text-xs font-medium underline hover:text-danger-500","aria-label":"Dismiss error",children:"Dismiss"})]})]})]})}F.__docgenInfo={description:`HierarchicalCombobox — the root component.\r
\r
ARIA 1.2 Combobox Pattern\r
─────────────────────────\r
The input has role="combobox" with:\r
  - aria-expanded:         true when dropdown is open\r
  - aria-controls:         points to the listbox id\r
  - aria-activedescendant: points to the currently highlighted option's DOM id\r
\r
The listbox has role="listbox" with:\r
  - Each visible row has role="option"\r
  - aria-selected reflects the checkbox selection state\r
\r
Keyboard Navigation\r
───────────────────\r
Focus stays on the input at all times. We track a "highlighted index"\r
into the flatNodes array and use aria-activedescendant to communicate\r
the active row to screen readers. This avoids the complexity of\r
physically moving focus into virtualized rows that may not be in the DOM.\r
\r
  ArrowDown  → move highlight to next row\r
  ArrowUp    → move highlight to previous row\r
  ArrowRight → expand the highlighted node (if collapsed & has children)\r
  ArrowLeft  → collapse the highlighted node (if expanded)\r
  Enter      → toggle selection on the highlighted node\r
  Home       → jump to first row\r
  End        → jump to last row\r
  Escape     → close dropdown\r
\r
Scroll-into-view\r
────────────────\r
When the highlighted index changes via keyboard, we scroll the container\r
so the highlighted row is visible. The math:\r
\r
  targetScrollTop = highlightedIndex × ROW_HEIGHT_PX\r
\r
  If targetScrollTop < container.scrollTop → scroll up to show the row.\r
  If targetScrollTop + ROW_HEIGHT > container.scrollTop + containerHeight\r
    → scroll down so the row's bottom edge is visible.`,methods:[],displayName:"Combobox"};const oe={title:"Components/Combobox",component:F,parameters:{layout:"centered",docs:{description:{component:`Storybook stories for the HierarchicalCombobox.\r

Four stories cover the key scenarios:\r
 1. Default        – Small dataset (8 root departments, lazy-load children)\r
 2. LargeDataset   – 10,000 pre-loaded items to prove custom virtualization\r
 3. AsyncLoading   – Exaggerated network latency (2 seconds) per expand\r
 4. ErrorState     – Every expand triggers a simulated API failure`}}},decorators:[o=>l.jsx("div",{className:"w-[400px]",children:l.jsx(o,{})})]},S={};function Z(){const r=[];for(let e=0;e<200;e++){const n=j(`group-${e}`,`Group ${e+1}`,!0),c=[];for(let i=0;i<50;i++)c.push(j(`group-${e}-item-${i}`,`Group ${e+1} › Item ${i+1}`,!1));n.children=c,n.isOpen=!0,r.push(n)}return r}const T={args:{initialRootNodes:Z()}};function ee(o,t){return new Promise(e=>{setTimeout(()=>{const n=4+Math.floor(Math.random()*5),c=[];for(let i=0;i<n;i++)c.push(j(`${o}-${i}`,`${t} › Item ${i+1}`,Math.random()>.5));e(c)},2e3)})}const I={args:{fetchChildrenFn:ee}};function te(o,t){return new Promise((e,n)=>{setTimeout(()=>{n(new Error("Network error: unable to load children. Please try again."))},800)})}const E={args:{fetchChildrenFn:te}};S.parameters={...S.parameters,docs:{...S.parameters?.docs,source:{originalSource:"{}",...S.parameters?.docs?.source},description:{story:`Uses the built-in mock loader with 8 root departments.\r
Click any row to expand and lazy-load children after a 500ms delay.\r
This is the baseline interaction story.`,...S.parameters?.docs?.description}}};T.parameters={...T.parameters,docs:{...T.parameters?.docs,source:{originalSource:`{
  args: {
    initialRootNodes: generateLargeDataset()
  }
}`,...T.parameters?.docs?.source},description:{story:`10,200 visible rows (200 open groups × 50 children + 200 roots).\r
The dropdown should scroll smoothly with no jank — all rendering\r
is handled by the math-based virtualizer.`,...T.parameters?.docs?.description}}};I.parameters={...I.parameters,docs:{...I.parameters?.docs,source:{originalSource:`{
  args: {
    fetchChildrenFn: slowFetchChildren
  }
}`,...I.parameters?.docs?.source},description:{story:`Demonstrates loading state UX with a 2-second delay per expand.\r
Watch the skeleton animation while children load.`,...I.parameters?.docs?.description}}};E.parameters={...E.parameters,docs:{...E.parameters?.docs,source:{originalSource:`{
  args: {
    fetchChildrenFn: failingFetchChildren
  }
}`,...E.parameters?.docs?.source},description:{story:`Every expand attempt fails with an error banner.\r
The dismiss button clears the error, and you can retry.`,...E.parameters?.docs?.description}}};const se=["Default","LargeDataset","AsyncLoading","ErrorState"];export{I as AsyncLoading,S as Default,E as ErrorState,T as LargeDataset,se as __namedExportsOrder,oe as default};
